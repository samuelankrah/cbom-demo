<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBOM & PQC Planner — Privacy‑First Demo</title>
  <meta name="description" content="Friendly, client‑side demo to inventory certificates (CBOM), map ownership, and plan PQC migration. No private keys, anonymization on by default." />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Optional: PKIjs for PEM parsing (Lab Mode only) -->
  <script src="https://unpkg.com/asn1js/dist/asn1js.min.js"></script>
  <script src="https://unpkg.com/pvutils/dist/pvutils.min.js"></script>
  <script src="https://unpkg.com/pkijs/build/pkijs.min.js"></script>
  <style>
    :root { --brand:#2563eb; --brand-600:#2563eb; --brand-700:#1d4ed8; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .chip { @apply px-2 py-0.5 rounded-full text-xs font-semibold; }
    .kbd { @apply inline-block px-1.5 py-0.5 rounded border bg-white text-xs text-gray-700; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <div class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-500"></div>
      <div class="flex-1">
        <h1 class="text-lg font-extrabold tracking-tight">CBOM & PQC Planner</h1>
        <p class="text-xs text-gray-500">“Generated from public certificate metadata; no private keys processed.”</p>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <span class="chip bg-emerald-100 text-emerald-800">Privacy‑first</span>
        <span class="chip bg-indigo-100 text-indigo-800">PQC‑aware</span>
        <span class="chip bg-gray-100 text-gray-800">No data leaves browser</span>
      </div>
      <button id="openGuide" class="px-3 py-2 rounded-lg border text-sm hover:bg-gray-50">Quick Guide</button>
    </div>
  </div>

  <main class="max-w-6xl mx-auto p-4">
    <!-- Stepper -->
    <ol class="grid grid-cols-4 gap-2 mb-4">
      <li class="step active">
        <div class="p-3 rounded-xl bg-white shadow-soft border flex items-center gap-3">
          <div class="w-7 h-7 rounded-full bg-blue-600 text-white grid place-items-center text-sm">1</div>
          <div>
            <div class="font-semibold">Scan</div>
            <div class="text-xs text-gray-500">Find certificates (simulated connectors)</div>
          </div>
        </div>
      </li>
      <li class="step">
        <div class="p-3 rounded-xl bg-white shadow-soft border flex items-center gap-3">
          <div class="w-7 h-7 rounded-full bg-gray-200 text-gray-700 grid place-items-center text-sm">2</div>
          <div>
            <div class="font-semibold">Map</div>
            <div class="text-xs text-gray-500">AI suggests owner & environment</div>
          </div>
        </div>
      </li>
      <li class="step">
        <div class="p-3 rounded-xl bg-white shadow-soft border flex items-center gap-3">
          <div class="w-7 h-7 rounded-full bg-gray-200 text-gray-700 grid place-items-center text-sm">3</div>
          <div>
            <div class="font-semibold">Plan</div>
            <div class="text-xs text-gray-500">Prioritize PQC / renewals</div>
          </div>
        </div>
      </li>
      <li class="step">
        <div class="p-3 rounded-xl bg-white shadow-soft border flex items-center gap-3">
          <div class="w-7 h-7 rounded-full bg-gray-200 text-gray-700 grid place-items-center text-sm">4</div>
          <div>
            <div class="font-semibold">Export</div>
            <div class="text-xs text-gray-500">CBOM JSON/CSV</div>
          </div>
        </div>
      </li>
    </ol>

    <!-- Panels -->
    <section id="panel-scan" class="panel active grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h2 class="font-semibold text-lg mb-2">Step 1 · Where to look</h2>
        <p class="text-sm text-gray-600 mb-4">Pick data sources to simulate discovery (in production these are read‑only connectors to your PKI, cloud cert stores, and edge). No uploads required.</p>
        <div class="grid grid-cols-2 gap-2 mb-4">
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="central" checked disabled> Central CA (simulated)</label>
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="cloud" checked disabled> Cloud Cert Stores (sim.)</label>
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="edge" checked disabled> Edge/CDN (sim.)</label>
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="api" checked disabled> API Gateway (sim.)</label>
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="mesh" checked disabled> Service Mesh (sim.)</label>
          <label class="flex items-center gap-2 p-2 rounded-lg border bg-gray-50"><input type="checkbox" class="conn" value="dns" checked disabled> DNS/Passive (sim.)</label>
        </div>

        <div class="flex items-center gap-3 mb-4">
          <button id="btnScan" class="px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">Run Demo Scan</button>
          <button id="btnClear" class="px-4 py-3 rounded-xl border font-semibold hover:bg-gray-50">Clear</button>
          <label class="flex items-center gap-2 ml-auto text-sm"><input id="anonymize" type="checkbox" checked> Anonymization ON</label>
        </div>

        <details class="mb-2">
          <summary class="cursor-pointer select-none px-3 py-2 rounded-lg bg-white border font-semibold text-sm">Lab Mode (optional) — paste public certificate PEM or metadata JSON</summary>
          <div class="mt-3 space-y-2">
            <p class="text-sm text-emerald-700">Public certificates only. <span class="font-semibold">Never paste private keys.</span> The app blocks private‑key material.</p>
            <textarea id="pemInput" class="w-full h-28 p-2 border rounded-lg text-xs" placeholder="-----BEGIN CERTIFICATE-----\nMIIB...\n-----END CERTIFICATE-----"></textarea>
            <div class="flex items-center gap-2">
              <button id="btnParsePem" class="px-4 py-2 rounded-lg bg-gray-900 text-white font-semibold">Add Certs</button>
              <button id="btnLoadJson" class="px-4 py-2 rounded-lg border font-semibold">Load JSON</button>
              <input id="fileJson" type="file" accept="application/json" class="text-sm" />
            </div>
          </div>
        </details>

        <p class="text-[11px] text-gray-500 mt-2">Compliance guardrails: PCI DSS 4.0 (crypto governance intent), NIST CSF PR.DS/PR.IP, ISO 27001 (asset & crypto controls). Demo runs 100% in your browser.</p>
      </div>

      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <div class="flex items-center mb-3">
          <h2 class="font-semibold text-lg">Inventory Preview</h2>
          <div class="ml-auto text-xs text-gray-500">Found: <span id="foundCount">0</span></div>
        </div>
        <div class="overflow-auto border rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 text-left">Endpoint</th>
                <th class="px-3 py-2 text-left">Common Name (CN)</th>
                <th class="px-3 py-2 text-left">Algorithm</th>
                <th class="px-3 py-2 text-left">Key Size</th>
                <th class="px-3 py-2 text-left">Expires</th>
                <th class="px-3 py-2 text-left">External</th>
                <th class="px-3 py-2 text-left">Source</th>
              </tr>
            </thead>
            <tbody id="tbodyScan" class="divide-y"></tbody>
          </table>
        </div>
        <div class="flex justify-end mt-4">
          <button id="toMap" class="px-5 py-3 rounded-xl bg-blue-600 disabled:opacity-40 text-white font-semibold">Next: Map →</button>
        </div>
      </div>
    </section>

    <section id="panel-map" class="panel hidden grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h2 class="font-semibold text-lg mb-2">Step 2 · Ownership & Environment</h2>
        <p class="text-sm text-gray-600 mb-4">An AI correlator suggests <span class="font-semibold">owner, backup, and environment</span> using names/tags. Low‑confidence items are flagged for attestation.</p>
        <div id="ownershipStats" class="grid grid-cols-3 gap-3 mb-3"></div>
        <div class="overflow-auto border rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 text-left">Endpoint</th>
                <th class="px-3 py-2 text-left">Owner</th>
                <th class="px-3 py-2 text-left">Backup</th>
                <th class="px-3 py-2 text-left">Env</th>
                <th class="px-3 py-2 text-left">Confidence</th>
                <th class="px-3 py-2 text-left">Status</th>
              </tr>
            </thead>
            <tbody id="tbodyMap" class="divide-y"></tbody>
          </table>
        </div>
        <div class="flex justify-between mt-4">
          <button class="px-4 py-3 rounded-xl border font-semibold" data-back>← Back</button>
          <button id="toPlan" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-semibold">Next: Plan →</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h3 class="font-semibold mb-2">Why ownership mapping prevents outages</h3>
        <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
          <li>Alerts reach the right humans even when people change roles.</li>
          <li>Every cert is tied to a service and environment for faster action.</li>
          <li>Low‑confidence mappings are clearly flagged for attestation.</li>
        </ul>
        <div class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-xl text-sm">Tip: In production, connectors read metadata from PKI, cloud, and edge; the AI correlator uses service catalog, repos, and tickets. This demo simulates that behavior.</div>
      </div>
    </section>

    <section id="panel-plan" class="panel hidden grid md:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h2 class="font-semibold text-lg mb-1">Step 3 · PQC & Renewal Planning</h2>
        <p class="text-sm text-gray-600 mb-4">Adjust policy sliders to prioritize external, high‑value, and soon‑to‑expire services. Output is a hybrid (classical+PQC) rollout order.</p>
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
          <label class="block">External exposure
            <input id="wExternal" type="range" min="0" max="60" value="40" class="w-full">
          </label>
          <label class="block">Expiry urgency
            <input id="wExpiry" type="range" min="0" max="60" value="30" class="w-full">
          </label>
          <label class="block">Weak algorithms
            <input id="wWeak" type="range" min="0" max="60" value="20" class="w-full">
          </label>
          <label class="block">RSA‑2048 uplift
            <input id="wRsa" type="range" min="0" max="20" value="5" class="w-full">
          </label>
        </div>
        <div class="overflow-auto border rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 text-left">Service / Endpoint</th>
                <th class="px-3 py-2 text-left">Reason</th>
                <th class="px-3 py-2 text-left">Priority</th>
              </tr>
            </thead>
            <tbody id="tbodyPlan" class="divide-y"></tbody>
          </table>
        </div>
        <div class="flex justify-between mt-4">
          <button class="px-4 py-3 rounded-xl border font-semibold" data-back>← Back</button>
          <button id="toExport" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-semibold">Next: Export →</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h3 class="font-semibold mb-2">At‑a‑glance health</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-3 border rounded-xl">
            <div class="text-xs text-gray-500">Expiry distribution</div>
            <canvas id="expiryChart"></canvas>
          </div>
          <div class="p-3 border rounded-xl">
            <div class="text-xs text-gray-500">Algorithm / key size</div>
            <canvas id="algoChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-export" class="panel hidden">
      <div class="bg-white rounded-2xl border shadow-soft p-5">
        <h2 class="font-semibold text-lg mb-2">Step 4 · Export CBOM</h2>
        <p class="text-sm text-gray-600 mb-4">Download your Certificate Bill of Materials with provenance, policy notes, and anonymization state.</p>
        <div class="flex items-center gap-3 mb-3">
          <button id="btnExportJson" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-semibold">Download CBOM (JSON)</button>
          <button id="btnExportCsv" class="px-5 py-3 rounded-xl border font-semibold">Download Inventory (CSV)</button>
          <label class="flex items-center gap-2 ml-auto text-sm"><input id="exportAnon" type="checkbox" checked> Keep anonymized</label>
        </div>
        <div class="text-xs text-gray-500">Watermark: “Generated from public certificate metadata; no private keys processed.”</div>
        <div class="mt-6">
          <button class="px-4 py-3 rounded-xl border font-semibold" data-back>← Back</button>
          <button id="btnRestart" class="px-4 py-3 rounded-xl bg-gray-900 text-white font-semibold ml-2">Restart</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Quick Guide Modal -->
  <div id="guide" class="fixed inset-0 hidden bg-black/40 p-4 z-40">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl p-5 shadow-soft">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-500"></div>
        <div>
          <h3 class="font-bold text-lg">How to use this demo</h3>
          <p class="text-sm text-gray-600">Four simple steps. Everything runs in your browser. Public certificate data only.</p>
        </div>
        <button id="closeGuide" class="ml-auto px-3 py-2 rounded-lg border">Close</button>
      </div>
      <ol class="mt-3 space-y-2 text-sm list-decimal pl-5">
        <li><span class="font-semibold">Scan</span>: Click <em>Run Demo Scan</em> to simulate finding certs across common sources.</li>
        <li><span class="font-semibold">Map</span>: The AI correlator proposes owner, backup, and environment with a confidence score.</li>
        <li><span class="font-semibold">Plan</span>: Tune PQC policy sliders; see a prioritized hybrid rollout order.</li>
        <li><span class="font-semibold">Export</span>: Download CBOM (JSON) or Inventory (CSV) with a compliance watermark.</li>
      </ol>
      <div class="mt-3 p-3 bg-indigo-50 border border-indigo-100 rounded-xl text-xs text-indigo-900">Security defaults: anonymization ON; private‑key patterns blocked; no persistence; no network calls in demo.</div>
    </div>
  </div>

<script>
// --------------------- Utilities & Sample Data ---------------------
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));
const fmtDate = (iso) => new Date(iso).toLocaleDateString();
const daysUntil = (iso) => Math.ceil((new Date(iso)-new Date())/86400000);
const addDays = (n) => { const d=new Date(); d.setDate(d.getDate()+n); return d.toISOString(); };
function anonymizeStr(s){ return (s||'').replace(/[A-Za-z0-9]/g,'•'); }
function download(name, text, type='text/plain'){ const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

// Sample, diverse inventory across connectors
const SAMPLE_ITEMS=[
  {endpoint:'dns:api.payments.example',cn:'api.payments.example',san:['api.payments.example'],issuer:'Org-CA',serial:'A1',algorithm:'RSA',keyBits:2048,notAfter:addDays(20),environment:'prod',external:true,provenance:['central','edge']},
  {endpoint:'lb:orders.edge',cn:'orders.example',san:['orders.example'],issuer:'Public-CA',serial:'B1',algorithm:'ECDSA',keyBits:256,notAfter:addDays(280),environment:'prod',external:true,provenance:['edge','cloud']},
  {endpoint:'svc:vault.internal',cn:'vault.internal',san:['vault.internal'],issuer:'Org-CA',serial:'C1',algorithm:'RSA',keyBits:1024,notAfter:addDays(400),environment:'core',external:false,provenance:['central']},
  {endpoint:'api:ml-infer',cn:'ml-infer.internal',san:['ml-infer.internal'],issuer:'Edge-CA',serial:'D1',algorithm:'RSA',keyBits:4096,notAfter:addDays(5),environment:'prod',external:true,provenance:['api','mesh']},
];

// --------------------- State ---------------------
let state={ items:[], mapped:[], plan:[], anonymize:true };

function setStep(i){
  $$('.step').forEach((el,idx)=>{
    const num=el.querySelector('.w-7');
    if(idx===i){ el.classList.add('active'); num.classList.remove('bg-gray-200','text-gray-700'); num.classList.add('bg-blue-600','text-white'); }
    else { el.classList.remove('active'); num.classList.add('bg-gray-200','text-gray-700'); num.classList.remove('bg-blue-600','text-white'); }
  });
  $$('#panel-scan, #panel-map, #panel-plan, #panel-export').forEach(p=>p.classList.add('hidden'));
  [$('#panel-scan'), $('#panel-map'), $('#panel-plan'), $('#panel-export')][i].classList.remove('hidden');
}

// --------------------- Scan Panel ---------------------
function renderScan(){
  const tbody=$('#tbodyScan');
  tbody.innerHTML='';
  const data=state.items;
  $('#foundCount').textContent=data.length;
  data.forEach(x=>{
    const tr=document.createElement('tr'); tr.className='hover:bg-gray-50';
    const CN=state.anonymize?anonymizeStr(x.cn):x.cn;
    tr.innerHTML=`<td class="px-3 py-2">${x.endpoint}</td>
      <td class="px-3 py-2">${CN}</td>
      <td class="px-3 py-2">${x.algorithm}</td>
      <td class="px-3 py-2">${x.keyBits||''}</td>
      <td class="px-3 py-2">${fmtDate(x.notAfter)}</td>
      <td class="px-3 py-2">${x.external?'Yes':'No'}</td>
      <td class="px-3 py-2">${(x.provenance||[]).join(', ')}</td>`;
    tbody.appendChild(tr);
  });
  $('#toMap').disabled = data.length===0;
}

$('#btnScan').addEventListener('click',()=>{
  // In demo: instantly populate from connectors (simulated)
  state.items=[...SAMPLE_ITEMS];
  renderScan();
  // Nudge next button
  $('#toMap').classList.add('ring-4','ring-blue-200'); setTimeout(()=>$('#toMap').classList.remove('ring-4','ring-blue-200'),1200);
});
$('#btnClear').addEventListener('click',()=>{ state.items=[]; renderScan(); });
$('#anonymize').addEventListener('change',e=>{ state.anonymize=e.target.checked; renderScan(); });

// Lab mode: block private key material
function looksLikePrivateKey(s){ return /-----BEGIN (RSA |EC |)PRIVATE KEY-----/i.test(s||''); }
$('#btnParsePem').addEventListener('click', async ()=>{
  const text=$('#pemInput').value.trim(); if(!text) return;
  if(looksLikePrivateKey(text)){ alert('Private keys are not allowed. Public certificates only.'); return; }
  const blocks=text.match(/-----BEGIN CERTIFICATE-----[\s\S]+?-----END CERTIFICATE-----/g)||[];
  const parsed=await Promise.all(blocks.map(parsePemBlock));
  const clean=parsed.filter(Boolean);
  state.items=[...state.items, ...clean]; renderScan(); $('#pemInput').value='';
});
$('#btnLoadJson').addEventListener('click',()=> $('#fileJson').click());
$('#fileJson').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const j=JSON.parse(await f.text()); state.items=[...state.items, ...j]; renderScan(); }catch{ alert('Invalid JSON'); }});

// PEM parsing (minimal)
function pemToDer(pem){ const b64=pem.replace(/-----(BEGIN|END) CERTIFICATE-----/g,'').replace(/\s+/g,''); const bin=atob(b64); const u=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u[i]=bin.charCodeAt(i); return u.buffer; }
async function parsePemBlock(pem){ try{ const der=pemToDer(pem); const asn1=asn1js.fromBER(der); if(asn1.offset===-1) throw new Error('ASN.1 parse error'); const cert=new pkijs.Certificate({ schema: asn1.result });
  const subject=cert.subject.typesAndValues.find(tv=>tv.type==='2.5.4.3'); const cn=subject?subject.value.valueBlock.value:'unknown';
  let san=[]; for(const ext of cert.extensions||[]){ if(ext.extnID==='2.5.29.17'){ san=(ext.parsedValue.altNames||[]).map(a=>a.value||a.ip||''); }}
  const spki=cert.subjectPublicKeyInfo; const algOID=spki.algorithm.algorithmId; let algorithm='Other', keyBits=0; if(algOID==='1.2.840.113549.1.1.1'){ algorithm='RSA'; keyBits=spki.parsedKey.modulus.valueBlock.valueHex.byteLength*8; } if(algOID==='1.2.840.10045.2.1'){ algorithm='ECDSA'; keyBits=256; }
  return {endpoint:'pem:import', cn, san, issuer:cert.issuer.typesAndValues.map(tv=>tv.value.valueBlock.value).join(','), serial:String(cert.serialNumber.valueBlock.toString()), algorithm, keyBits, notAfter:cert.notAfter.value.toDate().toISOString(), environment:'unknown', external:false, provenance:['lab']}; } catch(e){ console.error(e); return null; } }

$('#toMap').addEventListener('click',()=>{ setStep(1); runMapping(); });

// --------------------- Map Panel ---------------------
function runMapping(){
  // Simple AI-ish mapper: derive owner/env from endpoint/cn tokens
  state.mapped = state.items.map(x=>{
    const name=(x.cn||x.endpoint||'').toLowerCase();
    const env = /prod|payments|orders|edge/.test(name)?'prod': /vault|internal|dev|test/.test(name)?'dev':'prod';
    const team = name.includes('payments')? 'payments-api' : name.includes('orders')? 'orders' : name.includes('vault')? 'platform-security' : 'edge-services';
    const backup = team==='platform-security'? 'platform-core' : 'platform-security';
    const confidence = name.includes('internal')? 0.7 : 0.88; // toy heuristic
    const stale = false; // demo
    return { ...x, owner:{team, backup, confidence, stale} };
  });
  renderMap();
}

function renderMap(){
  const tbody=$('#tbodyMap'); tbody.innerHTML='';
  const stats={ mapped:0, low:0, total:state.mapped.length };
  state.mapped.forEach(m=>{
    const c = Math.round(m.owner.confidence*100);
    if(c>=75) stats.mapped++; else stats.low++;
    const tr=document.createElement('tr'); tr.className='hover:bg-gray-50';
    tr.innerHTML=`<td class="px-3 py-2">${state.anonymize?anonymizeStr(m.endpoint):m.endpoint}</td>
      <td class="px-3 py-2">${m.owner.team}</td>
      <td class="px-3 py-2">${m.owner.backup}</td>
      <td class="px-3 py-2">${m.environment}</td>
      <td class="px-3 py-2">${c}%</td>
      <td class="px-3 py-2">${c<75?'<span class=\'chip bg-amber-100 text-amber-800\'>needs attestation</span>':'<span class=\'chip bg-emerald-100 text-emerald-800\'>ok</span>'}</td>`;
    tbody.appendChild(tr);
  });
  const box=(title,val,desc)=>`<div class="p-3 border rounded-xl"><div class="text-xs text-gray-500">${title}</div><div class="text-xl font-extrabold">${val}</div><div class="text-[11px] text-gray-500">${desc}</div></div>`;
  $('#ownershipStats').innerHTML = box('Items', stats.total,'total discovered') + box('Mapped ≥75% conf.', stats.mapped,'ready for automation') + box('Needs attestation', stats.low,'human review');
}

$$('[data-back]').forEach(b=> b.addEventListener('click',()=>{ const i=$$('.panel').findIndex(p=>!p.classList.contains('hidden')); setStep(Math.max(0,i-1)); }));
$('#toPlan').addEventListener('click',()=>{ setStep(2); recomputePlan(); drawCharts(); });

// --------------------- Plan Panel ---------------------
function scoreItem(x,w){
  const days = daysUntil(x.notAfter);
  const soon = days<=30? (days<=7?30:20) : 0;
  const weak = (x.algorithm==='RSA'&&x.keyBits<2048)||(x.algorithm==='ECDSA'&&x.keyBits<256) ? 20:0;
  const rsa = (x.algorithm==='RSA'&&x.keyBits===2048)? 5:0;
  const ext = x.external? 40:0;
  return Math.round(ext*w.ext + soon*w.exp + weak*w.weak + rsa*w.rsa);
}

function recomputePlan(){
  const w={ ext: +$('#wExternal').value/40, exp:+$('#wExpiry').value/30, weak:+$('#wWeak').value/20, rsa:+$('#wRsa').value/5 };
  const ranked = state.mapped.map(x=>{
    const s=scoreItem(x,w); const reasons=[];
    if(x.external) reasons.push('external');
    const d=daysUntil(x.notAfter); if(d<=30) reasons.push(d<=7?'expires ≤7d':'expires ≤30d');
    if((x.algorithm==='RSA'&&x.keyBits<2048)||(x.algorithm==='ECDSA'&&x.keyBits<256)) reasons.push('weak key');
    if(x.algorithm==='RSA'&&x.keyBits===2048) reasons.push('RSA‑2048 uplift');
    return { ...x, priority:s, reasons:reasons.join(', ')};
  }).sort((a,b)=>b.priority-a.priority);
  state.plan=ranked;
  const tbody=$('#tbodyPlan'); tbody.innerHTML='';
  ranked.forEach(r=>{
    const tr=document.createElement('tr'); tr.className='hover:bg-gray-50';
    const name=state.anonymize?anonymizeStr(r.cn):r.cn;
    tr.innerHTML=`<td class="px-3 py-2">${name} <span class="text-xs text-gray-500">(${r.endpoint})</span></td>
      <td class="px-3 py-2">${r.reasons||'-'}</td>
      <td class="px-3 py-2">${r.priority}</td>`;
    tbody.appendChild(tr);
  });
}

['#wExternal','#wExpiry','#wWeak','#wRsa'].forEach(id=> $(id).addEventListener('input',recomputePlan));
$('#toExport').addEventListener('click',()=>{ setStep(3); });

// Charts
function drawCharts(){
  const ctx1=$('#expiryChart'); const ctx2=$('#algoChart');
  const buckets={'≤7d':0,'8–30d':0,'31–90d':0,'>90d':0};
  state.mapped.forEach(c=>{ const d=daysUntil(c.notAfter); if(d<=7) buckets['≤7d']++; else if(d<=30) buckets['8–30d']++; else if(d<=90) buckets['31–90d']++; else buckets['>90d']++; });
  new Chart(ctx1,{type:'bar',data:{labels:Object.keys(buckets),datasets:[{label:'Count',data:Object.values(buckets)}]},options:{plugins:{legend:{display:false}},responsive:true}});
  const alg={'RSA <2048':0,'RSA ≥2048':0,'ECDSA <P‑256':0,'ECDSA ≥P‑256':0,'Other':0};
  state.mapped.forEach(c=>{ if(c.algorithm==='RSA') (c.keyBits<2048?alg['RSA <2048']++:alg['RSA ≥2048']++); else if(c.algorithm==='ECDSA') (c.keyBits<256?alg['ECDSA <P‑256']++:alg['ECDSA ≥P‑256']++); else alg['Other']++; });
  new Chart(ctx2,{type:'doughnut',data:{labels:Object.keys(alg),datasets:[{data:Object.values(alg)}]},options:{responsive:true}});
}

// --------------------- Export Panel ---------------------
function buildCBOM(){
  const policy={ anonymized: $('#exportAnon').checked, weights:{ external:+$('#wExternal').value, expiry:+$('#wExpiry').value, weak:+$('#wWeak').value, rsa:+$('#wRsa').value } };
  const items=state.plan.map(x=>({
    id: crypto.randomUUID(), endpoint:x.endpoint, cn: policy.anonymized?anonymizeStr(x.cn):x.cn, san:x.san||[], issuer:x.issuer, serial:x.serial,
    algorithm:x.algorithm, keyBits:x.keyBits, notBefore:x.notBefore||null, notAfter:x.notAfter, environment:x.environment, external:x.external,
    owner:x.owner, risk:{ score:0, notes:[] }, pqc:{ tagged: true, priority: x.priority, recommended: 'hybrid first' }, provenance:x.provenance
  }));
  const summary={ total:items.length, expiring30:items.filter(i=>daysUntil(i.notAfter)<=30).length, weak:items.filter(i=> (i.algorithm==='RSA'&&i.keyBits<2048)||(i.algorithm==='ECDSA'&&i.keyBits<256)).length, pqcTagged:items.filter(i=>i.pqc?.tagged).length };
  return { generatedAt:new Date().toISOString(), policy, summary, items, watermark:"Generated from public certificate metadata; no private keys processed." };
}

$('#btnExportJson').addEventListener('click',()=>{ const cbom=buildCBOM(); download(`cbom_${new Date().toISOString().slice(0,19)}.json`, JSON.stringify(cbom,null,2), 'application/json'); });
$('#btnExportCsv').addEventListener('click',()=>{
  if(!state.plan.length) return; const headers=['endpoint','cn','issuer','algorithm','keyBits','notAfter','environment','external','owner.team','owner.backup','priority'];
  const lines=[headers.join(',')];
  state.plan.forEach(r=>{ const row=[r.endpoint, state.anonymize?anonymizeStr(r.cn):r.cn, r.issuer, r.algorithm, r.keyBits||'', r.notAfter, r.environment, r.external, r.owner?.team||'', r.owner?.backup||'', r.priority]; lines.push(row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')); });
  download(`inventory_${new Date().toISOString().slice(0,19)}.csv`, lines.join('\n'), 'text/csv');
});
$('#btnRestart').addEventListener('click',()=>{ location.reload(); });

// --------------------- Guide Modal ---------------------
$('#openGuide').addEventListener('click',()=> $('#guide').classList.remove('hidden'));
$('#closeGuide').addEventListener('click',()=> $('#guide').classList.add('hidden'));

// Boot
setStep(0); renderScan();
</script>
</body>
</html>
